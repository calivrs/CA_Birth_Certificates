<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>California Electronic Birth Registration System</title>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
  </head>
  <body>
    <div id="pdfViewer"></div>
    <h2>12A. PARENT OR OTHER INFORMANT SIGNATURE</h2>
    <canvas
      id="signature12ACanvas"
      style="border: 2px solid black; display: block"
    ></canvas>

    <h2>13A. ATTENDANT/CERTIFIER - SIGNATURE AND DEGREE OR TITLE</h2>
    <canvas
      id="signature13ACanvas"
      style="border: 2px solid black; display: block"
    ></canvas>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 12px;
      "
    >
      <button onclick="saveSignaturesAndInsertIntoPDF()">Save</button>
    </div>

    <script>
      const signature12ACanvas = document.getElementById("signature12ACanvas");
      const signature13ACanvas = document.getElementById("signature13ACanvas");

      function resizeCanvas() {
        signature12ACanvas.width = window.innerWidth - 16;
        signature12ACanvas.height = signature12ACanvas.width / 2;

        signature13ACanvas.width = window.innerWidth - 16;
        signature13ACanvas.height = signature13ACanvas.width / 2;
      }

      window.addEventListener("resize", resizeCanvas, false);
      resizeCanvas();

      const signature12APad = new SignaturePad(signature12ACanvas);
      const signature13APad = new SignaturePad(signature13ACanvas);

      async function saveSignaturesAndInsertIntoPDF() {
        const signature12ADataUrl = signature12ACanvas.toDataURL("image/png");
        const signature13ADataUrl = signature13ACanvas.toDataURL("image/png");

        const modifiedPDFBytes = await insertSignatureIntoPDF(
          signature12ADataUrl,
          signature13ADataUrl
        );

        downloadModifiedPDF(modifiedPDFBytes);
      }

      async function insertSignatureIntoPDF(
        signature12ADataUrl,
        signature13ADataUrl
      ) {
        const pdfBytes = await fetch(
          "https://calivrs.github.io/CA_Birth_Certificates/birth_certificate_sample.pdf"
        ).then((res) => res.arrayBuffer());
        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = pdfDoc.getPages();
        const firstPage = pages[0];
        const pageHeight = firstPage.getHeight();

        const signature12AImageArray = dataURLToUint8Array(signature12ADataUrl);
        const signature12AImage = await pdfDoc.embedPng(signature12AImageArray);

        firstPage.drawImage(signature12AImage, {
          x: 165,
          y: pageHeight - 200 - 35,
          width: 70,
          height: 35
        });

        const signature13AImageArray = dataURLToUint8Array(signature13ADataUrl);
        const signature13AImage = await pdfDoc.embedPng(signature13AImageArray);

        firstPage.drawImage(signature13AImage, {
          x: 165,
          y: pageHeight - 225 - 35,
          width: 70,
          height: 35
        });

        const modifiedPDFBytes = await pdfDoc.save();
        return modifiedPDFBytes;
      }

      function dataURLToUint8Array(dataURL) {
        const base64 = dataURL.split(",")[1];

        const binaryString = atob(base64);

        const array = new Uint8Array(binaryString.length);

        for (let i = 0; i < binaryString.length; i++) {
          array[i] = binaryString.charCodeAt(i);
        }
        return array;
      }

      function downloadModifiedPDF(modifiedPDFBytes) {
        const blob = new Blob([modifiedPDFBytes], {
          type: "application/pdf"
        });
        const url = URL.createObjectURL(blob);

        const downloadLink = document.createElement("a");
        downloadLink.href = url;
        downloadLink.download = "birth_certificate_sample_signed.pdf";

        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      }
    </script>
  </body>
</html>
